# Barmaid

Barmaid is a command line tool to manipulate BTW files as generated by BarTender. This is a work in progress created from the need to automatically adjust strings on a large amount of label files.

```bash
Execute "./barmaid.sh -e file_in.btw" to extract container and separate prefix.
Execute "./barmaid.sh -c file_out.btw" to construct file_out.btw from fragments.
```

Layout of BTW files (WIP)
-
BTW files contain the following sections:

1. Header
  * Contains bits of metadata, overall quite boring
  * Barmaid stores the header in prefix.bin
2. Preview images
  * Two embedded PNG files. They're used as preview images and are not too interesting either.
  * The images are also stored in prefix.bin
3. Compressed binary container
  * The container encodes the label information, this is what we're after.
  * The extracted container is stored in container.bin

Manipulating the extracted container (WIP)
-
The container seems to be using an encoding somewhat similar to BER (ASN.1) allowing for serialisation of different kinds of objects. So far string objects have been identified as being prefixed with the header `FF FE FF XX` or `FF FE FF FF YY YY`, where `XX` encodes the number of UTF-16 (little endian) characters for up to 255 and `YY YY` (encoded little endian) for up to 65535. e.g.: `FF FE FF 03 41 00 42 00 43 00` encodes the string `ABC`. It is common to find a lot of empty strings with a length of zero (`FF FE FF 00`) in the container.

In addition to overwriting a string it is also possible to change the length of a string object by inserting or removing bytes, while adjusting the length field in the header accordingly. This even works if the container embeds binary blobs such as fonts and images.

Notes
-
The current way of detecting the container is quite naively searching for the end of the second embedded PNG and calculating an offset from there. If things break with upcoming versions, this will likely be the cause.
